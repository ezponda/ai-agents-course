{
  "name": "03 â€” Parallelization (3-way Analysis)",
  "nodes": [
    {
      "parameters": {
        "content": "ðŸ“– [Course documentation](https://ezponda.github.io/ai-agents-course/04c_parallelization.html)\n## Parallelization (Do tasks at the same time)\n**Goal:** Run independent analyses in parallel, then combine results.\n\n**How to run:** Click **Run: Parallelization**.\n\n**Pattern:** Split â†’ Analyze in parallel â†’ Merge â†’ Finalize",
        "height": 240,
        "width": 760,
        "color": 1
      },
      "id": "c3c6b2dc-8b82-497a-aae7-7918a3a69f69",
      "name": "NOTE â€” Parallelization",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        1320,
        -520
      ]
    },
    {
      "parameters": {},
      "id": "7b2fc618-c1ae-4087-842a-850c5e87e9c0",
      "name": "Run: Parallelization",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [
        1400,
        -200
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "acbfdeae-6792-487f-8ae5-6d6c6110adc6",
              "name": "email_subject",
              "type": "string",
              "value": "Can't access my account after password reset"
            },
            {
              "id": "40511289-8791-4e5f-8a14-6e3fdb311afe",
              "name": "email_body",
              "type": "string",
              "value": "Hello,\nI reset my password twice but I still can't log in. It says 'invalid token'.\nI'm trying to access my invoices before end of day.\nCan you help?\nâ€” Sam"
            }
          ]
        },
        "options": {}
      },
      "id": "79e03661-0800-4733-bbf2-d1b67ac8e92b",
      "name": "Input â€” Customer Email",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1620,
        -200
      ]
    },
    {
      "parameters": {
        "model": "openai/gpt-4o-mini",
        "options": {}
      },
      "id": "ece7d72e-773a-48ff-94aa-5a7025df951e",
      "name": "OpenRouter Chat Model (Parallelization)",
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        1520,
        40
      ]
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Subject: {{ $json.email_subject }}\nBody:\n{{ $json.email_body }}\n\nJSON:",
        "messages": {
          "messageValues": [
            {
              "message": "=Extract key facts from the email.\nReturn STRICT JSON with keys:\ncustomer_name, issue, deadline, requested_action, missing_info (array).\nReturn JSON only."
            }
          ]
        },
        "batching": {}
      },
      "id": "3aa6bf86-f125-425c-8720-df56f11947f0",
      "name": "Branch A â€” Extract Facts",
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.7,
      "position": [
        1920,
        -380
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "2fde2af2-6e98-4119-a1f1-38aed84a67d0",
              "name": "facts",
              "type": "object",
              "value": "={{ JSON.parse($json.text) }}"
            }
          ]
        },
        "keepOnlySet": true,
        "options": {}
      },
      "id": "df635144-4995-4247-baf0-07b4c5f8205a",
      "name": "Store Facts",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2160,
        -380
      ]
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Subject: {{ $json.email_subject }}\nBody:\n{{ $json.email_body }}\n\nJSON:",
        "messages": {
          "messageValues": [
            {
              "message": "=Classify sentiment and urgency.\nReturn STRICT JSON with keys:\nsentiment (positive|neutral|negative), urgency (low|medium|high), risk_flags (array).\nReturn JSON only."
            }
          ]
        },
        "batching": {}
      },
      "id": "25579e42-375a-4ae4-a1c8-129e57f930e3",
      "name": "Branch B â€” Sentiment & Urgency",
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.7,
      "position": [
        1920,
        -200
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "4054cf74-425a-4b01-9823-15e69488083b",
              "name": "sentiment",
              "type": "object",
              "value": "={{ JSON.parse($json.text) }}"
            }
          ]
        },
        "keepOnlySet": true,
        "options": {}
      },
      "id": "e29b6ae2-bdbe-4a3d-8a6e-141b825215c5",
      "name": "Store Sentiment",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2160,
        -200
      ]
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Subject: {{ $json.email_subject }}\nBody:\n{{ $json.email_body }}\n\nReply:",
        "messages": {
          "messageValues": [
            {
              "message": "=Draft a helpful customer support email reply.\nRules:\n- Friendly and concise\n- Ask for missing info only if needed\n- Offer 1â€“2 concrete next steps\n- Under 140 words\n\nOutput ONLY the reply text."
            }
          ]
        },
        "batching": {}
      },
      "id": "23ab9b9e-d413-4e8f-acc9-b988fee03787",
      "name": "Branch C â€” Draft Reply",
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.7,
      "position": [
        1920,
        -20
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "81dfa0a9-419c-4c83-a8a1-b4cd240edc4d",
              "name": "draft_reply",
              "type": "string",
              "value": "={{ $json.text }}"
            }
          ]
        },
        "keepOnlySet": true,
        "options": {}
      },
      "id": "b69600ee-d9b4-4941-8941-84db1491acd7",
      "name": "Store Draft Reply",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2160,
        -20
      ]
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {}
      },
      "id": "50d93af1-aa64-46ec-9d36-8982785a823e",
      "name": "Merge A+B",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        2420,
        -280
      ]
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {}
      },
      "id": "31c9ae9f-a601-4cac-a9c1-c87c973a6786",
      "name": "Merge (A+B)+C",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        2620,
        -120
      ]
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Customer: {{ $json.facts.customer_name }}\nIssue: {{ $json.facts.issue }}\nDeadline: {{ $json.facts.deadline }}\nRequested action: {{ $json.facts.requested_action }}\n\nSentiment: {{ $json.sentiment.sentiment }}\nUrgency: {{ $json.sentiment.urgency }}\nRisk flags: {{ $json.sentiment.risk_flags.join(', ') }}\n\nDraft reply:\n{{ $json.draft_reply }}\n\nFinal reply:",
        "messages": {
          "messageValues": [
            {
              "message": "=You are a senior support agent.\nYou will receive:\n- Parsed customer facts (name, issue, deadline, requested action)\n- Parsed sentiment analysis (sentiment, urgency, risk flags)\n- A draft reply\n\nTask:\n1) Improve the draft to match urgency and include any critical missing info questions.\n2) Keep it under 160 words.\n3) Output ONLY the final reply text."
            }
          ]
        },
        "batching": {}
      },
      "id": "d06ada39-f1f8-4127-a059-fa04267cd282",
      "name": "Finalize â€” One Improved Reply",
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.7,
      "position": [
        2860,
        -120
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "b4a7fe08-b345-4587-9d83-12fad6605477",
              "name": "final_reply",
              "type": "string",
              "value": "={{ $json.text }}"
            }
          ]
        },
        "keepOnlySet": true,
        "options": {}
      },
      "id": "73afc530-17d1-403d-9aa1-fe7a1b563a06",
      "name": "Output â€” Final Reply",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        3100,
        -120
      ]
    }
  ],
  "connections": {
    "Run: Parallelization": {
      "main": [
        [
          {
            "node": "Input â€” Customer Email",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Input â€” Customer Email": {
      "main": [
        [
          {
            "node": "Branch A â€” Extract Facts",
            "type": "main",
            "index": 0
          },
          {
            "node": "Branch B â€” Sentiment & Urgency",
            "type": "main",
            "index": 0
          },
          {
            "node": "Branch C â€” Draft Reply",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Branch A â€” Extract Facts": {
      "main": [
        [
          {
            "node": "Store Facts",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Branch B â€” Sentiment & Urgency": {
      "main": [
        [
          {
            "node": "Store Sentiment",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Branch C â€” Draft Reply": {
      "main": [
        [
          {
            "node": "Store Draft Reply",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Store Facts": {
      "main": [
        [
          {
            "node": "Merge A+B",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Store Sentiment": {
      "main": [
        [
          {
            "node": "Merge A+B",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Merge A+B": {
      "main": [
        [
          {
            "node": "Merge (A+B)+C",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Store Draft Reply": {
      "main": [
        [
          {
            "node": "Merge (A+B)+C",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Merge (A+B)+C": {
      "main": [
        [
          {
            "node": "Finalize â€” One Improved Reply",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Finalize â€” One Improved Reply": {
      "main": [
        [
          {
            "node": "Output â€” Final Reply",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenRouter Chat Model (Parallelization)": {
      "ai_languageModel": [
        [
          {
            "node": "Branch A â€” Extract Facts",
            "type": "ai_languageModel",
            "index": 0
          },
          {
            "node": "Branch B â€” Sentiment & Urgency",
            "type": "ai_languageModel",
            "index": 0
          },
          {
            "node": "Branch C â€” Draft Reply",
            "type": "ai_languageModel",
            "index": 0
          },
          {
            "node": "Finalize â€” One Improved Reply",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "meta": {
    "templateCredsSetupCompleted": false
  },
  "tags": []
}
